<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <script>
        let transactions = [
        {
            id: 333,
            sourceAccount: 'xx',
            targetAccount: 'yy',
            amount: 100,
            category: 'extra',
            time: '2018-03-02T10:34:30.000Z'
        },{
            id: 33,
            sourceAccount: 'xx',
            targetAccount: 'yy',
            amount: 100,
            category: 'extra',
            time: '2018-03-02T10:34:30.000Z'
        },{
            id: 3,
            sourceAccount: 'A',
            targetAccount: 'B',
            amount: 100,
            category: 'eating_out',
            time: '2018-03-02T10:34:30.000Z'
        },{
            id: 1,
            sourceAccount: 'A',
            targetAccount: 'B',
            amount: 100,
            category: 'eating_out',
            time: '2018-03-02T10:33:00.000Z'
        },{
            id: 6,
            sourceAccount: 'A',
            targetAccount: 'C',
            amount: 250,
            category: 'other',
            time: '2018-03-02T10:33:05.000Z'
        },{
            id: 4,
            sourceAccount: 'A',
            targetAccount: 'B',
            amount: 100,
            category: 'eating_out',
            time: '2018-03-02T10:36:00.000Z'
        },{
            id: 2,
            sourceAccount: 'A',
            targetAccount: 'B',
            amount: 100,
            category: 'eating_out',
            time: '2018-03-02T10:33:50.000Z'
        },{
            id: 5,
            sourceAccount: 'A',
            targetAccount: 'C',
            amount: 250,
            category: 'other',
            time: '2018-03-02T10:33:00.000Z'
            }
        ];
        
        findDuplicateTransactions(transactions);

        
        function findDuplicateTransactions (transactions = []) {
            var result = groupBy(transactions, function(item)
            {
                return [item.sourceAccount, item.targetAccount, item.amount, item.category];
            });
            
            result = removeUniqueElements(result);
            
            Array.prototype.diff = function(a) {
                return this.filter(function(i) {return a.indexOf(i) < 0;});
            };
            var manterEstes = removeElementsByDate(result);
            var removerEstes = transactions.diff(manterEstes);

        
            result.forEach(element1 => {
                element1.forEach((element2, index) => {
                    removerEstes.forEach(element3 => {
                        if(element2.id == element3.id){
                            console.info("encontrei o elemento a ser removido: ");
                            console.info(element2);
                            element1.splice(index, 1);
                        }
                    });
                });
            });

            return result;
        }

        function removeUniqueElements(array){
            var filtered = array.filter(function(value, index, arr){
                return value.length >= 2;
            });

            return filtered;
        }

        function removeUniqueElements(array){
            var filtered = array.filter(function(value, index, arr){
                return value.length >= 2;
            });

            return filtered;
        }

        function removeElementsByDate(array){
            var filtered = [];

            for(var i = 0; i<array.length; i++){
                //blocos maiores
                var blocoMaior = array[i];
                console.info("-------------> inicio do bloco: " + i)

                for(var j = 0; j<blocoMaior.length; j++){
                    //blocos menores
                    var blocoMenor = blocoMaior[j];

                    for(var w = 0; w<blocoMaior.length; w++){
                        var blocoMenorNovamente = blocoMaior[w];

                        if(blocoMenor.id != blocoMenorNovamente.id){
                            console.info("comparando o item: " + blocoMenor.id + " com " + blocoMenorNovamente.id);
    
                            var date1 = new Date(blocoMenorNovamente.time);
                            var date2 = new Date(blocoMenor.time);
            
                            var timeDiff = Math.abs(date2.getTime() - date1.getTime());
                            if( timeDiff < 60000) {
                                //blocoMaior.splice(i, 1);
                                console.info("podem ser iguais");
                                blocoMenor.flag = true;
                                filtered.push(blocoMenor);
                            }
                        }
                    };
                    
                }
            }

            return filtered;

        }

        function groupBy( array , f ){
            var lists = {};
            array.forEach( function( o ){
                var list = JSON.stringify( f(o) );
                lists[list] = lists[list] || [];
                lists[list].push( o );  
            });
            return Object.keys(lists).map( function( list ){
                return lists[list]; 
            })
        }


    </script>
</body>
</html>