<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <script>
        let transactions2 = [
        {
            id: 333,
            sourceAccount: 'xx',
            targetAccount: 'yy',
            amount: 100,
            category: 'extra',
            time: '2018-03-02T10:34:30.000Z'
        },{
            id: 33,
            sourceAccount: 'xx',
            targetAccount: 'yy',
            amount: 100,
            category: 'extra',
            time: '2018-03-02T10:34:30.000Z'
        },{
            id: 3,
            sourceAccount: 'A',
            targetAccount: 'B',
            amount: 100,
            category: 'eating_out',
            time: '2018-03-02T10:34:30.000Z'
        },{
            id: 1,
            sourceAccount: 'A',
            targetAccount: 'B',
            amount: 100,
            category: 'eating_out',
            time: '2018-03-02T10:33:00.000Z'
        },{
            id: 6,
            sourceAccount: 'A',
            targetAccount: 'C',
            amount: 250,
            category: 'other',
            time: '2018-03-02T10:33:05.000Z'
        },{
            id: 4,
            sourceAccount: 'A',
            targetAccount: 'B',
            amount: 100,
            category: 'eating_out',
            time: '2018-03-02T10:36:00.000Z'
        },{
            id: 2,
            sourceAccount: 'A',
            targetAccount: 'B',
            amount: 100,
            category: 'eating_out',
            time: '2018-03-02T10:33:50.000Z'
        },{
            id: 5,
            sourceAccount: 'A',
            targetAccount: 'C',
            amount: 250,
            category: 'other',
            time: '2018-03-02T10:33:00.000Z'
            }
        ];
        
        let transactions = [ { id: 201,
            sourceAccount: 'company_x',
            targetAccount: 'my_account',
            amount: 10000,
            category: 'pension_benefits',
            time: '2018-02-25T08:00:00.000Z' },
        { id: 13,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -50,
            category: 'eating_out',
            time: '2018-04-01T10:24:00.000Z' },
        { id: 8,
            sourceAccount: 'my_account',
            targetAccount: 'restaurant',
            amount: -670,
            category: 'eating_out',
            time: '2018-03-02T18:54:45.000Z' },
        { id: 27,
            sourceAccount: 'company_x',
            targetAccount: 'my_account',
            amount: 10000,
            category: 'salary',
            time: '2018-04-25T08:00:00.000Z' },
        { id: 24,
            sourceAccount: 'my_account',
            targetAccount: 'fitness_club',
            amount: -610,
            category: 'other',
            time: '2018-04-22T11:54:10.000Z' },
        { id: 101,
            sourceAccount: 'company_x',
            targetAccount: 'my_account',
            amount: 240,
            category: 'salary',
            time: '2018-02-25T08:00:30.000Z' },
        { id: 12,
            sourceAccount: 'my_account',
            targetAccount: 'bowling_place',
            amount: -600,
            category: 'other',
            time: '2018-03-05T21:12:10.000Z' },
        { id: 25,
            sourceAccount: 'my_account',
            targetAccount: 'supermarket',
            amount: -850,
            category: 'groceries',
            time: '2018-04-20T18:51:31.000Z' },
        { id: 37,
            sourceAccount: 'my_account',
            targetAccount: 'supermarket',
            amount: -1690,
            category: 'groceries',
            time: '2018-05-10T18:14:10.000Z' },
        { id: 29,
            sourceAccount: 'my_account',
            targetAccount: 'cinema',
            amount: -580,
            category: 'other',
            time: '2018-05-05T20:01:18.000Z' },
        { id: 11,
            sourceAccount: 'my_account',
            targetAccount: 'supermarket',
            amount: -1540,
            category: 'groceries',
            time: '2018-03-05T16:24:31.000Z' },
        { id: 22,
            sourceAccount: 'my_account',
            targetAccount: 'restaurant',
            amount: -970,
            category: 'eating_out',
            time: '2018-04-17T19:52:46.000Z' },
        { id: 32,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -90,
            category: 'eating_out',
            time: '2018-05-07T09:56:09.000Z' },
        { id: 36,
            sourceAccount: 'my_account',
            targetAccount: 'internet_shop',
            amount: -1650,
            category: 'other',
            time: '2018-05-08T21:36:41.000Z' },
        { id: 28,
            sourceAccount: 'my_account',
            targetAccount: 'supermarket',
            amount: -1870,
            category: 'groceries',
            time: '2018-05-05T10:24:30.000Z' },
        { id: 17,
            sourceAccount: 'my_account',
            targetAccount: 'supermarket',
            amount: -1870,
            category: 'groceries',
            time: '2018-04-05T10:24:30.000Z' },
        { id: 14,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -50,
            category: 'eating_out',
            time: '2018-04-01T10:24:40.000Z' },
        { id: 30,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -90,
            category: 'eating_out',
            time: '2018-05-07T09:54:21.000Z' },
        { id: 39,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -70,
            category: 'eating_out',
            time: '2018-05-15T09:12:20.000Z' },
        { id: 3,
            sourceAccount: 'my_account',
            targetAccount: 'supermarket',
            amount: -1000,
            category: 'groceries',
            time: '2018-03-01T17:28:32.000Z' },
        { id: 41,
            sourceAccount: 'my_account',
            targetAccount: 'supermarket',
            amount: -850,
            category: 'groceries',
            time: '2018-05-20T18:51:31.000Z' },
        { id: 4,
            sourceAccount: 'my_account',
            targetAccount: 'cinema',
            amount: -330,
            category: 'other',
            time: '2018-03-01T20:10:15.000Z' },
        { id: 5,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -50,
            category: 'eating_out',
            time: '2018-03-02T09:25:20.000Z' },
        { id: 26,
            sourceAccount: 'my_account',
            targetAccount: 'cinema',
            amount: -450,
            category: 'other',
            time: '2018-04-23T19:13:10.000Z' },
        { id: 23,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -70,
            category: 'eating_out',
            time: '2018-04-15T09:12:20.000Z' },
        { id: 31,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -90,
            category: 'eating_out',
            time: '2018-05-07T09:55:10.000Z' },
        { id: 18,
            sourceAccount: 'my_account',
            targetAccount: 'cinema',
            amount: -580,
            category: 'other',
            time: '2018-04-05T20:01:18.000Z' },
        { id: 10,
            sourceAccount: 'my_account',
            targetAccount: 'fitness_club',
            amount: -560,
            category: 'other',
            time: '2018-03-04T12:54:10.000Z' },
        { id: 9,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -50,
            category: 'eating_out',
            time: '2018-03-04T07:14:20.000Z' },
        { id: 38,
            sourceAccount: 'my_account',
            targetAccount: 'restaurant',
            amount: -970,
            category: 'eating_out',
            time: '2018-05-17T19:52:46.000Z' },
        { id: 15,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -50,
            category: 'eating_out',
            time: '2018-04-01T10:25:10.000Z' },
        { id: 42,
            sourceAccount: 'my_account',
            targetAccount: 'cinema',
            amount: -450,
            category: 'other',
            time: '2018-05-23T19:13:10.000Z' },
        { id: 2,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -50,
            category: 'eating_out',
            time: '2018-03-01T12:34:00.000Z' },
        { id: 20,
            sourceAccount: 'my_account',
            targetAccount: 'internet_shop',
            amount: -1650,
            category: 'other',
            time: '2018-04-08T21:36:41.000Z' },
        { id: 40,
            sourceAccount: 'my_account',
            targetAccount: 'fitness_club',
            amount: -610,
            category: 'other',
            time: '2018-05-22T11:54:10.000Z' },
        { id: 1,
            sourceAccount: 'company_x',
            targetAccount: 'my_account',
            amount: 10000,
            category: 'salary',
            time: '2018-02-25T08:00:00.000Z' },
        { id: 33,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -90,
            category: 'eating_out',
            time: '2018-05-07T09:57:05.000Z' },
        { id: 6,
            sourceAccount: 'my_account',
            targetAccount: 'internet_shop',
            amount: -250,
            category: 'other',
            time: '2018-03-01T22:16:40.000Z' },
        { id: 16,
            sourceAccount: 'company_x',
            targetAccount: 'my_account',
            amount: 10000,
            category: 'salary',
            time: '2018-03-25T08:10:00.000Z' },
        { id: 19,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -90,
            category: 'eating_out',
            time: '2018-04-07T09:54:21.000Z' },
        { id: 21,
            sourceAccount: 'my_account',
            targetAccount: 'supermarket',
            amount: -1690,
            category: 'groceries',
            time: '2018-04-10T18:14:10.000Z' },
        { id: 35,
            sourceAccount: 'my_account',
            targetAccount: 'coffee_shop',
            amount: -90,
            category: 'eating_out',
            time: '2018-05-07T09:58:06.000Z' },
        { id: 102,
            sourceAccount: 'my_account',
            targetAccount: 'internet_shop',
            amount: -250,
            category: 'other',
            time: '2018-03-01T22:16:50.000Z' },
        { id: 7,
            sourceAccount: 'my_account',
            targetAccount: 'supermarket',
            amount: -160,
            category: 'groceries',
            time: '2018-03-02T13:14:00.000Z' } ];


            
        findDuplicateTransactions(transactions);

        
        function findDuplicateTransactions (transactions = []) {
            var result = groupBy(transactions, function(item)
            {
                return [item.sourceAccount, item.targetAccount, item.amount, item.category];
            });
            
            result = removeUniqueElements(result);
            
            Array.prototype.diff = function(a) {
                return this.filter(function(i) {return a.indexOf(i) < 0;});
            };
            var manterEstes = removeElementsByDate(result);
            var removerEstes = transactions.diff(manterEstes);

        
            result.forEach(element1 => {
                element1.forEach((element2, index) => {
                    removerEstes.forEach(element3 => {
                        if(element2.id == element3.id){
                            console.info("encontrei o elemento a ser removido: ");
                            console.info(element2);
                            element1.splice(index, 1);
                        }
                    });
                });
            });


            result.forEach(element1 => {
                element1.sort(sortByDate)
            });

            //console.info(result[1]);

            return result;
        }

        function sortByDate(a,b){  
            var dateA = new Date(a.time).getTime();
            var dateB = new Date(b.time).getTime();
            return dateA > dateB ? 1 : -1;  
        }; 

        function sortByID(a,b){  
            return a.id > b.id ? 1 : -1;  
        }; 

        function removeUniqueElements(array){
            var filtered = array.filter(function(value, index, arr){
                return value.length >= 2;
            });

            return filtered;
        }

        function removeUniqueElements(array){
            var filtered = array.filter(function(value, index, arr){
                return value.length >= 2;
            });

            return filtered;
        }

        function removeElementsByDate(array){
            var filtered = [];

            for(var i = 0; i<array.length; i++){
                //blocos maiores
                var blocoMaior = array[i];
                console.info("-------------> inicio do bloco: " + i)

                for(var j = 0; j<blocoMaior.length; j++){
                    //blocos menores
                    var blocoMenor = blocoMaior[j];

                    for(var w = 0; w<blocoMaior.length; w++){
                        var blocoMenorNovamente = blocoMaior[w];

                        if(blocoMenor.id != blocoMenorNovamente.id){
                            console.info("comparando o item: " + blocoMenor.id + " com " + blocoMenorNovamente.id);
    
                            var date1 = new Date(blocoMenorNovamente.time);
                            var date2 = new Date(blocoMenor.time);
            
                            var timeDiff = Math.abs(date2.getTime() - date1.getTime());
                            if( timeDiff < 60000) {
                                //blocoMaior.splice(i, 1);
                                console.info("podem ser iguais");
                                blocoMenor.flag = true;
                                filtered.push(blocoMenor);
                            }
                        }
                    };
                    
                }
            }

            return filtered;

        }

        function groupBy( array , f ){
            var lists = {};
            array.forEach( function( o ){
                var list = JSON.stringify( f(o) );
                lists[list] = lists[list] || [];
                lists[list].push( o );  
            });
            return Object.keys(lists).map( function( list ){
                return lists[list]; 
            })
        }


    </script>
</body>
</html>